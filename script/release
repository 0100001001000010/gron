#!/bin/bash
PROJDIR=$(cd `dirname $0`/.. && pwd)

TAG=${1}
USER="tomnomnom"
REPO="gron"
BINARY="${REPO}"

if [[ -z "${TAG}" ]]; then
    echo "Usage: ${0} <tag>"
    exit 1
fi

if [[ -z "${GITHUB_TOKEN}" ]]; then
    echo "You forgot to set your GITHUB_TOKEN"
    exit 2
fi

cd ${PROJDIR}

# Check if tag exists
git fetch --tags
git tag | grep "^${TAG}$"

if [ $? -ne 0 ]; then
    github-release release \
        --user ${USER} \
        --repo ${REPO} \
        --tag ${TAG} \
        --name "${REPO} v${TAG}" \
        --description "v${TAG}" \
        --pre-release
fi


for OS in "darwin" "linux"; do

    rm -f ${BINARY}

    GOOS=${OS} GOARCH=amd64 go build github.com/${USER}/${REPO}

    ARCHIVE="${BINARY}-${OS}-amd64-${TAG}.tgz"
    tar --create --gzip --file=${ARCHIVE} ${BINARY}

    github-release upload \
        --user ${USER} \
        --repo ${REPO} \
        --tag ${TAG} \
        --name "${ARCHIVE}" \
        --file ${PROJDIR}/${ARCHIVE}
done
